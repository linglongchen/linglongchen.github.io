
# 计算机网络之三次握手和四次挥手

作者： 陈汤姆
<br/>博客：[https://github.com/linglongchen/linglongchen.github.io](https://github.com/linglongchen/linglongchen.github.io)

>自我学习的积累！😄




## 三次握手
![1324014-20200307173529163-43735160.png](https://s2.loli.net/2024/08/19/1eThKoIZlYkGUtV.png)

### 过程

- 第一步：客户端的TCP程序首先向服务器的TCP程序发送一个TCP报文。SYN标志位设置位1，并且携带序号seq为客户端的随机序号值。（**<font color=Magenta>SYN=1,seq=client_isn</font>**）
- 第二步：包含SYN=1的报文被服务器接收，服务器网络层对报文做处理，抽取SYN值然后交给传输层，然后服务端为TCP请求分配资源，并响应客户端TCP报文。响应的TCP报文SYN也是为1(代表这是我收到客户端的请求的回复)；设置ack等于client_isn+1（表示是当前请求的确认报文）；设置seq为服务端的随机序号值。（<font color=Magenta>SYN=1，ack=client_isn+1，seq=server_isn</font>）
- 第三步：客户端收到服务端响应的TCP报文段，客户端开始分配资源，此时双方都已经分配了资源，已经算是建立了连接。此时客户端需要再发送给客户端一个<font color=Magenta>接收确认报文</font>。设置SYN=0（和初始建立连接区别开来）；seq=client_isn+1（标记为当前客户端的请求报文顺序）；ack=server_isn+1（表明该请求是服务端的确认请求）（<font color=Magenta>SYN=1；seq=client_isn+1；ack=server_isn+1</font>）

以上三步客户端与服务端就算建立了连接，双方可以互相发送数据。


### 为什么要第三次？

- 反证法：
	- 1. 假设没有第三次握手，服务端响应给客户端第二次握手，那么导致的问题是什么？服务器无法知道客户端是否收到了确认请求，因此服务器无法主动传输数据，只能被动等待客户端的传输请求。
- 辩证法：
	- 通过第三次握手可以实现客户端主动告知服务端已经收到了响应，完成了连接，可以<font color=Magenta>互相传输数据</font>了


## 四次挥手
![1324014-20200307173553667-1935490469.png](https://s2.loli.net/2024/08/19/8XEOkovtHeUGmwh.png)


### 过程

- 第一步：客户端发送一个 <font color=Magenta>FIN</font> 标志位置位的 TCP 数据包给服务器，表示数据发送完毕。
- 第二步：服务器接收到客户端发来的断开连接报文，向客户端回复这个报文的<font color=Magenta>确认报文（ACK字段为1）</font>，告诉服务器已经接收到FIN报文。
- 第三步：一段时间后，服务器如果没有更多的数据要发送给客户端，也会发送一个 <font color=Magenta>`FIN` </font>标志位置位的 TCP 数据包给客户端，表示服务器端的数据发送完毕。
- 第四步：客户端接收到服务器的 FIN 包后，会发送一个确认应答<font color=Magenta>ACK</font>，表示已经收到了服务器的 `FIN` 包。之后服务器会主动关闭连接。


### 连接状态
-  **CLOSE_WAIT 状态**：
    - 服务器在发送完第一个 `ACK` 包后会进入 `CLOSE_WAIT` 状态，等待客户端发送 `FIN` 包。如果服务器端还有数据需要发送，则会继续发送数据，直到发送完毕。
-  **LAST_ACK 状态**：
    - 服务器在发送完 `FIN` 包后会进入 `LAST_ACK` 状态，等待客户端的最后一个 `ACK` 包。一旦接收到这个 `ACK` 包，服务器就会关闭连接。
-  **TIME_WAIT 状态**：
    - 客户端在发送完最后一个 `ACK` 包之后会进入 `TIME_WAIT` 状态，在这个状态下客户端会等待两倍的 `MSL`（Maximum Segment Lifetime，最大段生存时间）时间，以确保服务器端能够正确接收到最后一个 `ACK` 包。这是为了避免在<font color=Magenta>网络拥塞</font>的情况下，最后一个 `ACK` 包<font color=Magenta>丢失</font>导致服务器重发 `FIN` 包。



### 为什么要四次？
- TCP是<font color=Magenta>全双工</font>的通道
	- 客户端----->服务端是单独的一条通道代表客户端向服务端传输数据的通道
	- 服务端----->客户端也是单独的一条通道代表服务端向客户端传输数据的通道
	- 前两次的交互代表客户端向服务端发送的数据通道可以关闭，后两次的交互代表服务端向客户端发送数据的通道可以关闭

## 总结
以上就是三次握手和四次挥手的个人总结。
