# 我的双十一压测报告

作者： 陈汤姆
<br/>博客：[https://github.com/linglongchen/linglongchen.github.io](https://github.com/linglongchen/linglongchen.github.io)

>自我学习的积累！😄



## 背景
我所在的公司属于跨境物流，也会经历双十一的大促，针对双十一大促公司每年都会在双十一前的一个月组织一次全链路的压测。

压测可以量化当前系统架构是否可承载当前至未来一段时间的业务量。压测也是找出系统瓶颈的重要手段，可以帮助开发同学明确需要优化的功能。有效的压测+有效的性能优化是保证业务稳定运行、系统高可用的必要条件。



去年双十一我作为团队压测的PM跟测试团队对我们团队的应用做了两轮压测，以下就是对于压测的报告。


## 应用配置

我们团队负责的核心平台有两个：
- 全公司的接单平台（负责对接外部公司对接我们公司的数据入口），共三个核心应用，每个应用12个pod，pod配置为4C8G。
- 物流协同平台（负责串联物流包裹的协同平台）共三个核心应用，每个应用24个pod，pod配置为4C8G


日均单量属于公司保密数据无法提供。

通过流量对比，双十一流量日均是平时流量的4倍。


## 压测目标

### 找出系统水位
系统濒临阈值时（例如CPU达到80% or 内存溢出 or 磁盘使用率超过90%等 ），QPS以及对应RT为该系统的水位值。

通过找出系统水位判断流量是否满足业务要求，如果系统存在瓶颈需要开发进行性能优化。


### 判断业务是否正常运行

在稳定的QPS流量压测下，系统是否稳定运行，核心链路是否正常运行，MQ是否出现堆积,RT是否升高。

通过稳定的流量判断系统在大促场景下是否可以正常运行

## 压测流程

### 压测方案确认
#### 确认压测的流量QPS的值
#### 压测数据上传


### 压测预热

#### 打开低流量QPS
#### 低流量验证系统链路可用性


### 正式压测

#### 打开正式压测QPS流量
#### 对流量实施摸高、限流，观察系统水位


### 压测报告

#### 找出系统瓶颈

#### 梳理系统水位

#### 输出压测报告


### 压测复盘

#### 拉齐各域针对系统瓶颈做优化

#### 针对压测系统水位评估系统扩容



##### 注：压测过程中任何一个系统出现异常都应立即停止压测流量，待确认系统影响确认无影响后才能继续压测。

## 压测方案

我们公司压测是通过内部自研的压测框架实现的全链路压测，公司所有的应用都接入了压测框架，通过最上游携带压测标，通过压测标串通全链路。

整个压测框架的核心：
- 对Http请求进行增强，传递压测标
- 对MQ增强传递压测标，隔离压测流量
- mybatis识别压测标进行sql改写，压测流量写入影子表


### 压测脚本

测试通过Jmeter实现的一套压测脚本，主要针对核心链路的脚本。


### 接口压测

- 描述：对单个接口进行压测
- 测过程中发现部分接口是系统性能瓶颈，那么需要在接口性能优化前后进行压测，通过观察优化前后的性能变化来判断优化方案是否有效。


### 核心链路压测

- 描述：大促期间影响核心业务的链路，对承载系统高比例qps的业务链路或者存在高危操作的业务链路进行压测
- 场景：通过压测核心业务链路来衡量全链路系统稳定性

### 瓶颈链路压测
- 描述：对系统瓶颈链路压测（例如高并发请求导致db连接池爆满、大数据量的请求导致FGC频繁）等
- 场景：在性能优化前后对瓶颈链路进行压测，判断性能优化的方案是否奏效。


### 全链路压测
- 描述：对系统的全部链路通过QPS配比执行全量压测（例如上下游依赖的链路）
- 场景：系统更多的涉及上下游依赖采取全链路压测可以更全的覆盖各个域




### 不影响线上

- 描述：为了压测的真实性，压测在线上执行，但是在业务的低峰期进行，降低对线上的影响，另外也通过其它方式降低对线上的影响，分别为数据隔离和中间件隔离

#### 数据隔离
压测数据通过压测标写入影子表，不影响线上数据

#### 中间件隔离
中国压测标将压测流量打到其它中间件实例，避免对线上造成影响




## 数据指标

压测过程中关注的指标如下：
### TPS
每秒处理的事务数（每秒发出请求到响应处理的最大数量）
### QPS
每秒查询率（每秒接收的请求数量）
### RT
请求的响应时间
### CPU
主要关注CPU使用率，一般超过80%告警
### 内存
关注的是整个集群的内存使用率，一般超过70%告警
### JVM-FGC
关注FGC的发生频率，如果FGC频繁需要额外关注
### MQ
关注MQ的数据堆积和消费TPS。
### 数据库-CPU
关注数据库的CPU，如果CPU过高需要DBA排查是否存在慢SQL或者大事务
### 数据库-内存
关注数据库的内存使用情况，内存使用过高则表明流量过大数据库暂无法支持，需要DBA扩容
### redis
关注redis的内存使用情况，如果内存使用过高则需要排查缓存过期时间是否合理或者扩容
### schdulerX
关注调度任务的堆积情况，如果堆积超过一定数量需要排查调度任务的执行情况是否存在系统瓶颈或者调度任务配置不合理


## 压测报告
针对域内以上的数据指标梳理压测报告。


## 风险评估
压测前要做好风险评估，避免压测对线上产生影响，主要考虑风险如下：

### 线上应用的风险
压测前要提前对应用扩容，避免未扩容的应用执行压测影响线上业务。

### 压测时间的风险
压测时间是否合理。一般在业务低峰期执行压测


### 压测故障的紧急预案
出现压测故障如何紧急止血，紧急预案如何快速降低影响面，降低资损。