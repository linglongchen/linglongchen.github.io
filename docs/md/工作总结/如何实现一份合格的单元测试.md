# 如何实现一份合格的单元测试



![[Pasted image 20240909124826.png]]

单元测试编写基于Junit4+mockito

## 背景

cngfc-engine新增了部分代码，cngfc-engine需要增加行增量单测，chatGPT写了几个版本一直不通过，梳理整体如下写单测流程保障一次通过。

修改代码如下：

```java
List<FulfillTask> assembleBigBagNotifyTask(EngineBatchContext batchContext, HandingUnitDTO handingUnitDO) {
List<FulfillTask> fulfillTaskList = new ArrayList<>();  
  
//如果接收方是测试状态，则只组装批次code是CNTEST开头的批次  
if (isResInTestAndBatchNotTest(handingUnitDO.getConsigneeResCode(), batchContext.getBatchCode())) {  
    return Collections.emptyList();  
}  
if (StringUtils.isEmpty(handingUnitDO.getLaneCode())) {  
    List<HandingUnitRelationDTO> relationDOs = engineHandingUnitReadServiceV2Client.queryHandingUnitRelation(handingUnitDO.getHuCode(), null,  
            null, null, RelateTypeEnum.MAIN_NET_RELATION.getCode());  
    if (!CollectionUtils.isEmpty(relationDOs)) {  
        HandingUnitRelationDTO handingUnitRelationDO = relationDOs.get(0);  
        String lgOrderCode = handingUnitRelationDO.getLgOrderCode();  
        DcpTmsOrderDTO dcpTmsOrderDTO = engineCndcpTmsOrderServiceClient.queryParentTmsOrder(lgOrderCode);  
        if (dcpTmsOrderDTO == null) {  
            throw new GFCException(ErrorCodeEnum.CNGFC_G_TMS_ORDER_NOT_FOUND,  
                    "huCode:" + handingUnitDO.getHuCode());  
        }  
        handingUnitDO.setLaneCode(laneReadService.getLaneCode(lgOrderCode));  
    }  
}  
  
List<LaneDTO> laneDTOList = laneReadService.queryLanesByLaneCode(handingUnitDO.getLaneCode());  
  
LaneDTO laneDTO = engineLaneUtils.chooseRightLane(laneDTOList, handingUnitDO.getTemplateCode());  
  
GFCAssertUtils.notNull(laneDTO, "渠道配置不能为空");  
  
FulfillTask fulfillTask = new FulfillTask(handingUnitDO.getId(),  
        ScheduleTaskTypeEnum.BIGBAG_ACTIVITY.getTaskType(), batchContext.getProductCode());  
  
String productCode = handingUnitDO.getFeatureByKey(AssembleConstants.FEATURE_PRODUCT_CODE);  
if (StringUtils.isEmpty(productCode)) {  
    productCode = laneDTO.getProductCode();  
}  
  
fulfillTask.setProductCode(productCode);  
//创建大包时写入Lane关联的templateCode  
fulfillTask.setTemplateCode(handingUnitDO.getTemplateCode());  
//设置为接收方资源code  
fulfillTask.setResCode(handingUnitDO.getConsigneeResCode());  
//接收方资源是Lane中第一个资源，所以类型是Lane中第一个资源的类型  
String nodeCode = batchContext.getNodeCode();  
fulfillTask.setNodeCode(nodeCode);  
//订单维度找出来的activityCode和模板对应的不一定一致  
fulfillTask.setActivityCode(batchContext.getActivityCode());
if (nodeCode.equals(NodeCodeEnum.LINEHAUL.getCode())) {
	//省略部分逻辑
} else if(nodeCode.equals(NodeCodeEnum.SORTING_CENTER.getCode())) {
	//新增代码开始
	if (EngineCommonSwitch.TRANSFER_CONSOLIDATION_DETAIL_NOTIFY_DUPLICATE_SC_SWITCH) {  
	    String resCode = null;  
	    List<HandingUnitRelationDTO> relationDOs = engineHandingUnitReadServiceV2Client.queryHandingUnitRelation(handingUnitDO.getHuCode(), null,  
	            null, null, RelateTypeEnum.MAIN_NET_RELATION.getCode());  
	    if (CollectionUtils.isEmpty(relationDOs)) {  
	        log.error("lzdNewConsolidationNotifyTaskFactory assembleBigBagNotifyTask relationDOs is empty error,bigBadId:{}",handingUnitDO.getHuCode());  
	        throw new GFCException(ErrorCodeEnum.CNGFC_B_AE_HANDOVER_NO_HANDINGUNIT_RELATION);  
	    }  
	    HandingUnitRelationDTO handingUnitRelationDO = relationDOs.get(0);  
	    String lgOrderCode = handingUnitRelationDO.getLgOrderCode();  
	    FulfillOrderQueryDTO fulfillOrderQueryDO = new FulfillOrderQueryDTO();  
	    List<FulfillOrderDTO> fulfillOrderDOS = engineFulfillOrderReadServiceClient.queryFulfillOrder(lgOrderCode, fulfillOrderQueryDO);  
	    for (FulfillOrderDTO fulfillOrderDO : fulfillOrderDOS) {  
	        if (NodeCodeEnum.SORTING_CENTER.getCode().equals(fulfillOrderDO.getNodeCode())) {  
	            resCode = fulfillOrderDO.getResCode();  
	        }  
	    }  
	    if(StringUtils.isBlank(resCode)){  
	        log.error("lzdNewConsolidationNotifyTaskFactory assembleBigBagNotifyTask transit resCode is empty error,bigBadId:{},lgOrderCode:{}",handingUnitDO.getHuCode(),lgOrderCode);  
	        throw new GFCException(ErrorCodeEnum.CNGFC_G_RES_CODE_NOT_FOUND);  
	    }  
	    fulfillTask.setResCode(resCode);  
	}
	//新增代码结束
}

```
整体修改点：
- 查询大小包关联关系
- 判空异常
- 查询履行单数据
- 获取资源code
- 设置资源code

## 实现

书写单元测试的整体流程如下:


### 初始化参数
- 初始化入参的必填值（后续需要使用的值）

以上代码需要初始化batchContext、handingUnitDTO、EngineCommonSwitch.TRANSFER_CONSOLIDATION_DETAIL_NOTIFY_DUPLICATE_SC_SWITCH（要保证单侧可以覆盖true内的逻辑）


```java
EngineCommonSwitch.TRANSFER_CONSOLIDATION_DETAIL_NOTIFY_DUPLICATE_SC_SWITCH = true;  
HandingUnitDTO handingUnitDO = new HandingUnitDTO();  
handingUnitDO.setHuCode("testHuCode");  
handingUnitDO.setLaneCode("testLaneCode");  
handingUnitDO.setTemplateCode("testTemplateCode");  
handingUnitDO.setConsigneeResCode("testConsigneeResCode");  
List<HandingUnitRelationDTO> relationDOs = new ArrayList<>();  
HandingUnitRelationDTO handingUnitRelationDO = new HandingUnitRelationDTO();  
handingUnitRelationDO.setLgOrderCode("testLgOrderCode");  
relationDOs.add(handingUnitRelationDO);  
FulfillOrderDTO fulfillOrderDO = new FulfillOrderDTO();  
fulfillOrderDO.setNodeCode(NodeCodeEnum.SORTING_CENTER.getCode());  
fulfillOrderDO.setResCode("testResCode");  
  
EngineBatchContext batchContext = new EngineBatchContext();  
batchContext.setPreNodeCode("CONSO");  
batchContext.setNodeCode("SORTING_CENTER");  
batchContext.setActivityCode("TRANSFER_CONSOLIDATION_DETAIL_NOTIFY");  
batchContext.setLaneCode("testLaneCode");  
batchContext.setBatchCode("testBatchCode");  
batchContext.setSortNum(3);  
  
LaneDTO laneDTO = new LaneDTO();  
laneDTO.setProductCode("testProductCode");
```

### 第三方依赖赋值

以上代码中需要依赖底层数据库层或者第三方接口查询数据，因此需要mock这部分的值。
在单测中可以使用when关键字实现，即可以mock调用这个数据库接口或者第三方接口时响应为自己mock的值。
```java
when(laneReadService.queryLanesByLaneCode(anyString())).thenReturn(Lists.newArrayList(laneDTO));  
when(engineLaneUtils.chooseRightLane(anyList(), anyString())).thenReturn(laneDTO);  
when(engineHandingUnitReadServiceV2Client.queryHandingUnitRelation(handingUnitDO.getHuCode(), null, null, null, RelateTypeEnum.MAIN_NET_RELATION.getCode()))  
        .thenReturn(relationDOs);  
when(engineFulfillOrderReadServiceClient.queryFulfillOrder(anyString(), any(FulfillOrderQueryDTO.class)))  
        .thenReturn(Lists.newArrayList(fulfillOrderDO));  
  
when(handoverDiamondConfig.isResInTest(fulfillOrderDO.getResCode())).thenReturn(false);  
when(taskFactory.isResInTestAndBatchNotTest(fulfillOrderDO.getResCode(),anyString())).thenReturn(false);
```

注意点：数据库操作或者第三方的操作需要传入参数，传入参数的类型需要额外注意，如果要求为null就不能传anyString()

### 调用待测试方法

以上数据和接口都初始化成功后就可以调用需要执行单测的方法。
```java
List<FulfillTask> fulfillTasks = taskFactory.assembleBigBagNotifyTask(batchContext, handingUnitDO);
```

### 结果断言

最后一部就是设置断言，断言的作用就是判断是否满足要测试的结果。

```java
// Add assertions to validate the generated FulfillTasks  
assertFalse(fulfillTasks.isEmpty());  
assertEquals(1, fulfillTasks.size());  
FulfillTask fulfillTask = fulfillTasks.get(0);  
assertEquals(ScheduleTaskTypeEnum.BIGBAG_ACTIVITY.getTaskType(), fulfillTask.getTaskType());  
assertEquals(batchContext.getProductCode(), fulfillTask.getProductCode());  
assertEquals(handingUnitDO.getTemplateCode(), fulfillTask.getTemplateCode());  
assertEquals(handingUnitDO.getConsigneeResCode(), fulfillTask.getResCode());  
assertEquals(batchContext.getNodeCode(), fulfillTask.getNodeCode());  
assertEquals(batchContext.getActivityCode(), fulfillTask.getActivityCode());  
assertEquals(handingUnitDO.getHuCode(), fulfillTask.getMainCode());  
assertEquals(laneDTO.getProductCode(), fulfillTask.getProductCode());  
assertEquals(batchContext.getSortNum().toString(), fulfillTask.getSortNum());  
assertEquals(String.valueOf(batchContext.getUserId()), fulfillTask.getUserId());
```

![[Pasted image 20240909143112.png]]



## 整体单测代码如下

```java
    @Test  
    public void testAssembleBigBagNotifyTask_withSwitchOnAndValidData() {  
        // Given  
        EngineCommonSwitch.TRANSFER_CONSOLIDATION_DETAIL_NOTIFY_DUPLICATE_SC_SWITCH = true;  
        HandingUnitDTO handingUnitDO = new HandingUnitDTO();  
        handingUnitDO.setHuCode("testHuCode");  
        handingUnitDO.setLaneCode("testLaneCode");  
        handingUnitDO.setTemplateCode("testTemplateCode");  
        handingUnitDO.setConsigneeResCode("testConsigneeResCode");  
        List<HandingUnitRelationDTO> relationDOs = new ArrayList<>();  
        HandingUnitRelationDTO handingUnitRelationDO = new HandingUnitRelationDTO();  
        handingUnitRelationDO.setLgOrderCode("testLgOrderCode");  
        relationDOs.add(handingUnitRelationDO);  
        FulfillOrderDTO fulfillOrderDO = new FulfillOrderDTO();  
        fulfillOrderDO.setNodeCode(NodeCodeEnum.SORTING_CENTER.getCode());  
        fulfillOrderDO.setResCode("testResCode");  
  
        EngineBatchContext batchContext = new EngineBatchContext();  
        batchContext.setPreNodeCode("CONSO");  
        batchContext.setNodeCode("SORTING_CENTER");  
        batchContext.setActivityCode("TRANSFER_CONSOLIDATION_DETAIL_NOTIFY");  
        batchContext.setLaneCode("testLaneCode");  
        batchContext.setBatchCode("testBatchCode");  
        batchContext.setSortNum(3);  
  
        LaneDTO laneDTO = new LaneDTO();  
        laneDTO.setProductCode("testProductCode");  
  
  
        // When  
        when(laneReadService.queryLanesByLaneCode(anyString())).thenReturn(Lists.newArrayList(laneDTO));  
        when(engineLaneUtils.chooseRightLane(anyList(), anyString())).thenReturn(laneDTO);  
        when(engineHandingUnitReadServiceV2Client.queryHandingUnitRelation(handingUnitDO.getHuCode(), null, null, null, RelateTypeEnum.MAIN_NET_RELATION.getCode()))  
                .thenReturn(relationDOs);  
        when(engineFulfillOrderReadServiceClient.queryFulfillOrder(anyString(), any(FulfillOrderQueryDTO.class)))  
                .thenReturn(Lists.newArrayList(fulfillOrderDO));  
  
        when(handoverDiamondConfig.isResInTest(fulfillOrderDO.getResCode())).thenReturn(false);  
        when(taskFactory.isResInTestAndBatchNotTest(fulfillOrderDO.getResCode(),anyString())).thenReturn(false);  
  
  
  
  
        // Invoke the method  
        List<FulfillTask> fulfillTasks = taskFactory.assembleBigBagNotifyTask(batchContext, handingUnitDO);  
  
//        // Then  
        // Add assertions to validate the generated FulfillTasks        assertFalse(fulfillTasks.isEmpty());  
        assertEquals(1, fulfillTasks.size());  
        FulfillTask fulfillTask = fulfillTasks.get(0);  
        assertEquals(ScheduleTaskTypeEnum.BIGBAG_ACTIVITY.getTaskType(), fulfillTask.getTaskType());  
        assertEquals(batchContext.getProductCode(), fulfillTask.getProductCode());  
        assertEquals(handingUnitDO.getTemplateCode(), fulfillTask.getTemplateCode());  
        assertEquals(handingUnitDO.getConsigneeResCode(), fulfillTask.getResCode());  
        assertEquals(batchContext.getNodeCode(), fulfillTask.getNodeCode());  
        assertEquals(batchContext.getActivityCode(), fulfillTask.getActivityCode());  
        assertEquals(handingUnitDO.getHuCode(), fulfillTask.getMainCode());  
        assertEquals(laneDTO.getProductCode(), fulfillTask.getProductCode());  
        assertEquals(batchContext.getSortNum().toString(), fulfillTask.getSortNum());  
        assertEquals(String.valueOf(batchContext.getUserId()), fulfillTask.getUserId());  
    }
```