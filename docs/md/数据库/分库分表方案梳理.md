# 分库分表方案梳理

作者： 陈汤姆
<br/>博客：[https://github.com/linglongchen/linglongchen.github.io](https://github.com/linglongchen/linglongchen.github.io)

>自我学习的积累！😄




## 1.背景




## 2.技术选型

通过前期筛选，对开源框架zebra、shardingSphere、tddl的调研，决定选择shardingSphere来作为分库中间件。ShardingSphere配置相对简单，一般情况下使用几乎无感知，支持特定情况使用（支持tkMybatis插件，PageHelper插件）。

## 3.实现原理

ShardingSphere在**Statement**层面做处理，拦截SQL，并进行后续核心流程。核心流程由 SQL 解析 => 执行器优化 => SQL 路由 => SQL 改写 => SQL 执行 => 结果归并的流程组成。

  
![](https://cdn.nlark.com/yuque/0/2021/png/646823/1610695650838-4e9449e2-b69d-4871-b1b2-5b0a7ec3f558.png)

## 4.注意事项

- **分表以_${index}结尾**，比如business_operation,分表之后为business_operation_0.....business_operation_511
- 增删改查**必须指定分表字段**(指定表后缀除外)
- 表的**自增ID不允许做业务逻辑**
- 对于已实现分表方案的表，不允许使用join查询
- `CASE WHEN` 中不允许包含子查询
- `CASE WHEN` 中必须使用表别名
- 不支持 HAVING、UNION (ALL)
- 子查询中使用WHERE条件时，必须包含分片键，当外层查询中也包含分片键时，子查询和外层查询中的分片键必须保持一致
- 不允许对分表字段进行函数运算和使用运算表达式

  

## 5.分表计算逻辑

根据分表数量，做一致性hash计算，尽量使数据分布均匀。提供一致性hash分表索引计算工具类：ConsistentHashSelector。
